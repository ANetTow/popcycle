library(popcycle)

context("EVT filtering")

test_that("Filter EVT files", {
  x <- setUp()

  evt.files <- get.evt.files(x$evt.dir)
  save.filter.params(x$db)
  save.sfl(x$db, x$cruise, x$evt.dir)
  filter.evt.files(x$db, x$cruise, x$evt.dir, evt.files, x$opp.dir)
  opp.stats <- get.opp.stats.table(x$db)
  expect_equal(opp.stats[1, "file"], "2014_185/2014-07-04T00-00-02+00-00")
  expect_equal(opp.stats[2, "file"], "2014_185/2014-07-04T00-03-02+00-00")
  expect_equal(opp.stats[3, "file"], "2014_185/2014-07-04T00-12-02+00-00")
  expect_equal(opp.stats[1, "opp_count"], 345)
  expect_equal(opp.stats[2, "opp_count"], 404)
  expect_equal(opp.stats[3, "opp_count"], 365)
  expect_equal(opp.stats[1, "evt_count"], 40000)
  expect_equal(opp.stats[2, "evt_count"], 40000)
  expect_equal(opp.stats[3, "evt_count"], 40000)
  expect_equal(opp.stats[1, "notch1"], 0.766880341880342)
  expect_equal(opp.stats[2, "notch1"], 0.876873661670236)
  expect_equal(opp.stats[3, "notch1"], 0.792992950224311)
  expect_equal(opp.stats[1, "notch2"], 0.760381355932203)
  expect_equal(opp.stats[2, "notch2"], 0.867584745762712)
  expect_equal(opp.stats[3, "notch2"], 0.786440677966102)
  expect_equal(opp.stats[1, "origin"], -1792)
  expect_equal(opp.stats[2, "origin"], -1744)
  expect_equal(opp.stats[3, "origin"], -432)
  expect_equal(opp.stats[1, "fsc_small_min"], 1.16129192513726)
  expect_equal(opp.stats[2, "fsc_small_min"], 1.0158648592744)
  expect_equal(opp.stats[3, "fsc_small_min"], 1.14766319202265)
  expect_equal(opp.stats[1, "fsc_small_max"], 1166.19845288663)
  expect_equal(opp.stats[2, "fsc_small_max"], 3156.0618662238)
  expect_equal(opp.stats[3, "fsc_small_max"], 1485.50801717277)
  expect_equal(opp.stats[1, "fsc_small_mean"], 23.1879033296803)
  expect_equal(opp.stats[2, "fsc_small_mean"], 50.2361959272678)
  expect_equal(opp.stats[3, "fsc_small_mean"], 40.0813101646839)

  tearDown(x)
})
